generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  COLLABORATOR
  SUPPLIER
}

enum StatusListaRapida {
  RASCUNHO
  PENDENTE
  APROVADO
  REJEITADO
  ARQUIVADO
}

enum StatusSugestao {
  PENDENTE
  APROVADO
  REJEITADO
}

enum TipoPOP {
  ABERTURA
  FECHAMENTO
  LIMPEZA
  OPERACIONAL
  PERSONALIZADO
}

enum StatusPOPExecucao {
  EM_ANDAMENTO
  CONCLUIDO
  CANCELADO
}

enum StatusCotacao {
  ABERTA
  FECHADA
}

enum StatusChecklist {
  ABERTO
  FINALIZADO
}

enum StatusSubmissao {
  PENDENTE
  APROVADO
  REJEITADO
  PARCIAL
  ARQUIVADO
}

enum StatusPedido {
  PENDENTE
  APROVADO
  REJEITADO
}

model Restaurante {
  id       Int      @id @default(autoincrement())
  nome     String
  cnpj     String?  @unique
  ativo    Boolean  @default(true)
  criadoEm DateTime @default(now()) @map("criado_em")

  usuarios       Usuario[]
  items          Item[]
  areas          Area[]
  listas         Lista[]
  submissoes     Submissao[]
  fornecedores   Fornecedor[]
  cotacoes       Cotacao[]
  checklists     Checklist[]
  listaRapidas   ListaRapida[]
  sugestoes      SugestaoItem[]
  popTemplates   POPTemplate[]
  popExecucoes   POPExecucao[]
  notificacoes   Notificacao[]
  conviteTokens  ConviteToken[]

  @@map("restaurantes")
}

model Usuario {
  id            Int       @id @default(autoincrement())
  nome          String
  email         String    @unique
  username      String?   @unique
  senha         String
  role          UserRole  @default(COLLABORATOR)
  aprovado      Boolean   @default(false)
  ativo         Boolean   @default(true)
  restauranteId Int?      @map("restaurante_id")
  sessionToken  String?   @map("session_token")
  criadoEm      DateTime  @default(now()) @map("criado_em")

  restaurante       Restaurante?       @relation(fields: [restauranteId], references: [id])
  listas            ListaColaborador[]
  submissoes        Submissao[]
  listaRapidas      ListaRapida[]
  sugestoes         SugestaoItem[]
  popExecucoes      POPExecucao[]
  notificacoes      Notificacao[]
  pushSubscriptions PushSubscription[]

  @@map("usuarios")
}

model Item {
  id            Int      @id @default(autoincrement())
  nome          String
  unidadeMedida String   @map("unidade_medida")
  ativo         Boolean  @default(true)
  restauranteId Int      @map("restaurante_id")
  criadoEm      DateTime @default(now()) @map("criado_em")

  restaurante  Restaurante   @relation(fields: [restauranteId], references: [id])
  fornecedor   Fornecedor?   @relation(fields: [fornecedorId], references: [id])
  fornecedorId Int?          @map("fornecedor_id")
  listasRef       ListaItemRef[]
  pedidos         Pedido[]
  cotacaoItens    CotacaoItem[]
  checklistItens  ChecklistItem[]
  listaRapidaItens ListaRapidaItem[]
  sugestoesCriadas SugestaoItem[]

  @@map("itens")
}

model Area {
  id            Int      @id @default(autoincrement())
  nome          String
  restauranteId Int      @map("restaurante_id")
  criadoEm      DateTime @default(now()) @map("criado_em")

  restaurante Restaurante @relation(fields: [restauranteId], references: [id])

  @@map("areas")
}

model Lista {
  id            Int      @id @default(autoincrement())
  nome          String
  restauranteId Int      @map("restaurante_id")
  deletado      Boolean  @default(false)
  criadoEm      DateTime @default(now()) @map("criado_em")

  restaurante   Restaurante        @relation(fields: [restauranteId], references: [id])
  colaboradores ListaColaborador[]
  itensRef      ListaItemRef[]
  submissoes    Submissao[]

  @@map("listas")
}

model ListaColaborador {
  id        Int @id @default(autoincrement())
  listaId   Int @map("lista_id")
  usuarioId Int @map("usuario_id")

  lista   Lista   @relation(fields: [listaId], references: [id])
  usuario Usuario @relation(fields: [usuarioId], references: [id])

  @@unique([listaId, usuarioId])
  @@map("lista_colaborador")
}

model ListaItemRef {
  id               Int   @id @default(autoincrement())
  listaId          Int   @map("lista_id")
  itemId           Int   @map("item_id")
  quantidadeMinima Float   @default(0) @map("quantidade_minima")
  quantidadeAtual  Float   @default(0) @map("quantidade_atual")
  usaThreshold     Boolean @default(true) @map("usa_threshold")
  qtdFardo         Float?  @map("qtd_fardo")

  lista Lista @relation(fields: [listaId], references: [id])
  item  Item  @relation(fields: [itemId], references: [id])

  @@unique([listaId, itemId])
  @@map("lista_item_ref")
}

model Fornecedor {
  id            Int      @id @default(autoincrement())
  nome          String
  cnpj          String?
  telefone      String?
  email         String?
  ativo         Boolean  @default(true)
  restauranteId Int      @map("restaurante_id")
  criadoEm      DateTime @default(now()) @map("criado_em")
  atualizadoEm  DateTime @updatedAt @map("atualizado_em")

  restaurante  Restaurante   @relation(fields: [restauranteId], references: [id])
  itens        Item[]
  cotacaoItens CotacaoItem[]

  @@map("fornecedores")
}

model Submissao {
  id            Int             @id @default(autoincrement())
  listaId       Int             @map("lista_id")
  usuarioId     Int             @map("usuario_id")
  restauranteId Int             @map("restaurante_id")
  status        StatusSubmissao @default(PENDENTE)
  arquivada     Boolean         @default(false)
  criadoEm      DateTime        @default(now()) @map("criado_em")
  atualizadoEm  DateTime        @updatedAt @map("atualizado_em")

  lista       Lista       @relation(fields: [listaId], references: [id])
  usuario     Usuario     @relation(fields: [usuarioId], references: [id])
  restaurante Restaurante @relation(fields: [restauranteId], references: [id])
  pedidos     Pedido[]
  checklist   Checklist?

  @@map("submissoes")
}

model Pedido {
  id            Int          @id @default(autoincrement())
  submissaoId   Int          @map("submissao_id")
  itemId        Int          @map("item_id")
  qtdSolicitada Float        @map("qtd_solicitada")
  status        StatusPedido @default(PENDENTE)
  criadoEm      DateTime     @default(now()) @map("criado_em")
  atualizadoEm  DateTime     @updatedAt @map("atualizado_em")

  submissao Submissao @relation(fields: [submissaoId], references: [id])
  item      Item      @relation(fields: [itemId], references: [id])

  @@map("pedidos")
}

model Cotacao {
  id            Int           @id @default(autoincrement())
  titulo        String?
  status        StatusCotacao @default(ABERTA)
  restauranteId Int           @map("restaurante_id")
  criadoEm      DateTime      @default(now()) @map("criado_em")
  atualizadoEm  DateTime      @updatedAt @map("atualizado_em")

  restaurante Restaurante   @relation(fields: [restauranteId], references: [id])
  itens       CotacaoItem[]

  @@map("cotacoes")
}

model CotacaoItem {
  id            Int        @id @default(autoincrement())
  cotacaoId     Int        @map("cotacao_id")
  itemId        Int        @map("item_id")
  fornecedorId  Int?       @map("fornecedor_id")
  qtdSolicitada Float      @map("qtd_solicitada")
  precoUnitario Float?     @map("preco_unitario")
  criadoEm     DateTime   @default(now()) @map("criado_em")
  atualizadoEm DateTime   @updatedAt @map("atualizado_em")

  cotacao    Cotacao    @relation(fields: [cotacaoId], references: [id])
  item       Item       @relation(fields: [itemId], references: [id])
  fornecedor Fornecedor? @relation(fields: [fornecedorId], references: [id])

  @@map("cotacao_itens")
}

model Checklist {
  id            Int             @id @default(autoincrement())
  submissaoId   Int             @unique @map("submissao_id")
  status        StatusChecklist @default(ABERTO)
  restauranteId Int             @map("restaurante_id")
  criadoEm     DateTime        @default(now()) @map("criado_em")
  atualizadoEm DateTime        @updatedAt @map("atualizado_em")

  submissao   Submissao       @relation(fields: [submissaoId], references: [id])
  restaurante Restaurante     @relation(fields: [restauranteId], references: [id])
  itens       ChecklistItem[]

  @@map("checklists")
}

model ChecklistItem {
  id          Int       @id @default(autoincrement())
  checklistId Int       @map("checklist_id")
  itemId      Int       @map("item_id")
  qtdPedida   Float     @map("qtd_pedida")
  marcado     Boolean   @default(false)
  criadoEm   DateTime  @default(now()) @map("criado_em")

  checklist Checklist @relation(fields: [checklistId], references: [id])
  item      Item      @relation(fields: [itemId], references: [id])

  @@map("checklist_itens")
}

// ============================================================
// FASE 4 — Listas Rápidas, Sugestões de Itens, POPs
// ============================================================

model ListaRapida {
  id            Int               @id @default(autoincrement())
  restauranteId Int               @map("restaurante_id")
  usuarioId     Int               @map("usuario_id")
  nome          String
  status        StatusListaRapida @default(RASCUNHO)
  criadoEm      DateTime          @default(now()) @map("criado_em")
  atualizadoEm  DateTime          @updatedAt @map("atualizado_em")

  restaurante Restaurante       @relation(fields: [restauranteId], references: [id])
  usuario     Usuario           @relation(fields: [usuarioId], references: [id])
  itens       ListaRapidaItem[]

  @@map("listas_rapidas")
}

model ListaRapidaItem {
  id            Int       @id @default(autoincrement())
  listaRapidaId Int       @map("lista_rapida_id")
  nome          String
  quantidade    Float?
  unidade       String?
  itemId        Int?      @map("item_id")
  descartado    Boolean   @default(false)
  criadoEm      DateTime  @default(now()) @map("criado_em")

  listaRapida ListaRapida @relation(fields: [listaRapidaId], references: [id])
  item        Item?       @relation(fields: [itemId], references: [id])

  @@map("lista_rapida_itens")
}

model SugestaoItem {
  id            Int            @id @default(autoincrement())
  restauranteId Int            @map("restaurante_id")
  usuarioId     Int            @map("usuario_id")
  nome          String
  unidadeMedida String         @map("unidade_medida")
  status        StatusSugestao @default(PENDENTE)
  itemCriadoId  Int?           @map("item_criado_id")
  criadoEm      DateTime       @default(now()) @map("criado_em")
  atualizadoEm  DateTime       @updatedAt @map("atualizado_em")

  restaurante Restaurante @relation(fields: [restauranteId], references: [id])
  usuario     Usuario     @relation(fields: [usuarioId], references: [id])
  itemCriado  Item?       @relation(fields: [itemCriadoId], references: [id])

  @@map("sugestoes_itens")
}

model POPTemplate {
  id            Int      @id @default(autoincrement())
  restauranteId Int      @map("restaurante_id")
  nome          String
  tipo          TipoPOP
  descricao     String?
  ativo         Boolean  @default(true)
  criadoEm      DateTime @default(now()) @map("criado_em")
  atualizadoEm  DateTime @updatedAt @map("atualizado_em")

  restaurante Restaurante   @relation(fields: [restauranteId], references: [id])
  passos      POPPasso[]
  execucoes   POPExecucao[]

  @@map("pop_templates")
}

model POPPasso {
  id         Int    @id @default(autoincrement())
  templateId Int    @map("template_id")
  descricao  String
  ordem      Int

  template      POPTemplate      @relation(fields: [templateId], references: [id])
  execucaoItens POPExecucaoItem[]

  @@map("pop_passos")
}

model POPExecucao {
  id            Int               @id @default(autoincrement())
  templateId    Int               @map("template_id")
  usuarioId     Int               @map("usuario_id")
  restauranteId Int               @map("restaurante_id")
  status        StatusPOPExecucao @default(EM_ANDAMENTO)
  criadoEm      DateTime          @default(now()) @map("criado_em")
  atualizadoEm  DateTime          @updatedAt @map("atualizado_em")

  template    POPTemplate      @relation(fields: [templateId], references: [id])
  usuario     Usuario          @relation(fields: [usuarioId], references: [id])
  restaurante Restaurante      @relation(fields: [restauranteId], references: [id])
  itens       POPExecucaoItem[]

  @@map("pop_execucoes")
}

model POPExecucaoItem {
  id         Int      @id @default(autoincrement())
  execucaoId Int      @map("execucao_id")
  passoId    Int      @map("passo_id")
  marcado    Boolean  @default(false)
  observacao String?
  criadoEm   DateTime @default(now()) @map("criado_em")

  execucao POPExecucao @relation(fields: [execucaoId], references: [id])
  passo    POPPasso    @relation(fields: [passoId], references: [id])

  @@unique([execucaoId, passoId])
  @@map("pop_execucao_itens")
}

// ============================================================
// FASE 5 — Notificações, Convites, Auditoria
// ============================================================

enum TipoNotificacao {
  SUBMISSAO_PENDENTE
  SUBMISSAO_APROVADA
  SUBMISSAO_REJEITADA
  LISTA_RAPIDA_PENDENTE
  LISTA_RAPIDA_APROVADA
  LISTA_RAPIDA_REJEITADA
  SUGESTAO_APROVADA
  SUGESTAO_REJEITADA
}

model Notificacao {
  id            Int              @id @default(autoincrement())
  usuarioId     Int              @map("usuario_id")
  restauranteId Int              @map("restaurante_id")
  tipo          TipoNotificacao
  mensagem      String
  lida          Boolean          @default(false)
  criadoEm      DateTime         @default(now()) @map("criado_em")

  usuario     Usuario     @relation(fields: [usuarioId], references: [id])
  restaurante Restaurante @relation(fields: [restauranteId], references: [id])

  @@map("notificacoes")
}

model ConviteToken {
  id            Int      @id @default(autoincrement())
  token         String   @unique
  email         String?
  restauranteId Int?     @map("restaurante_id")
  role          UserRole @default(COLLABORATOR)
  usado         Boolean  @default(false)
  expiresAt     DateTime @map("expires_at")
  criadoEm      DateTime @default(now()) @map("criado_em")

  restaurante Restaurante? @relation(fields: [restauranteId], references: [id])

  @@map("convite_tokens")
}

model AppLog {
  id            Int      @id @default(autoincrement())
  restauranteId Int?     @map("restaurante_id")
  usuarioId     Int?     @map("usuario_id")
  acao          String
  entidade      String?
  entidadeId    Int?     @map("entidade_id")
  detalhes      Json?
  criadoEm      DateTime @default(now()) @map("criado_em")

  @@map("app_logs")
}

model PushSubscription {
  id        Int      @id @default(autoincrement())
  usuarioId Int      @map("usuario_id")
  endpoint  String   @unique
  p256dh    String
  auth      String
  criadoEm  DateTime @default(now()) @map("criado_em")

  usuario   Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@map("push_subscriptions")
}
